package utils

import (
	"io"

	. "cve-sa-backend/iniconf"

	"github.com/huaweicloud/huaweicloud-sdk-go-obs/obs"
)

func initObs() (client *obs.ObsClient, err error) {
	client, err = obs.New(Obs.AK, Obs.SK, Obs.Point, obs.WithSocketTimeout(60000), obs.WithConnectTimeout(60000))
	if err != nil {
		return nil, err
	}

	return
}

func DownloadFile(key string) (all []byte, _ error) {
	var object *obs.GetObjectOutput
	input := obs.GetObjectInput{
		GetObjectMetadataInput: obs.GetObjectMetadataInput{Bucket: Obs.Bucket, Key: key},
	}
	client, err := initObs()
	if err != nil {
		return nil, err
	}

	object, err = client.GetObject(&input)
	if err != nil {
		return nil, err
	}
	defer object.Body.Close()

	all, err = io.ReadAll(object.Body)
	if err != nil {
		return nil, err
	}

	return all, nil
}

func UploadFile(key string, body io.Reader) error {
	client, err := initObs()
	if err != nil {
		return err
	}
	input := &obs.PutObjectInput{}
	input.Bucket = Obs.Bucket
	input.Key = key
	input.Body = body
	_, err = client.PutObject(input)
	return err
}
