FROM openeuler/openeuler:23.03 as BUILDER
RUN dnf update -y && \
    dnf install -y golang && \
    go env -w GOPROXY=https://goproxy.cn,direct

MAINTAINER zengchen1024<chenzeng765@gmail.com>

# build binary
RUN mkdir -p /go/src/openeuler/cve-sa-backend

COPY . /go/src/openeuler/cve-sa-backend

RUN cd /go/src/openeuler/cve-sa-backend && go mod tidy && CGO_ENABLED=1 go build -v -o ./cve-sa-backend main.go

# copy binary config and utils
FROM openeuler/openeuler:22.03
RUN dnf -y update && \
    dnf in -y shadow && \
    groupadd -g 1000 cve-sa-backend && \
    useradd -u 1000 -g cve-sa-backend -s /bin/bash -m cve-sa-backend && \
    mkdir -p /opt/app/ && chown -R 1000:1000 /opt/app/

ENV TimeZone=Asia/Shanghai

RUN ln -snf /usr/share/zoneinfo/$TimeZone /etc/localtime && echo $TimeZone > /etc/timezone

USER cve-sa-backend

RUN mkdir -p /opt/app/cve-sa-backend/conf/ && mkdir /opt/app/cve-sa-backend/webapp

COPY --chown=cve-sa-backend conf/app_prod.ini /opt/app/cve-sa-backend/conf/app.ini

COPY --chown=cve-sa-backend ./webapp/manager.html /opt/app/cve-sa-backend/webapp/manager.html

COPY --chown=cve-sa-backend --from=BUILDER /go/src/openeuler/cve-sa-backend/cve-sa-backend /opt/app/cve-sa-backend

COPY --chown=cve-sa-backend ./sh/epoch.sh /opt/app/epoch.sh

RUN chmod +x /opt/app/epoch.sh

WORKDIR /opt/app/cve-sa-backend/

ENTRYPOINT ["/opt/app/cve-sa-backend/cve-sa-backend"]