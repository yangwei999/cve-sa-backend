package models

import (
	"strings"
	"time"

	_const "cve-sa-backend/utils/const"
)

type CveSecurityNotice struct {
	Id                 int64     `gorm:"column:id" json:"id"`
	AffectedComponent  string    `gorm:"column:affected_component" description:"影响组件" json:"affectedComponent"`
	AffectedProduct    string    `gorm:"column:affected_product" description:"影响产品" json:"affectedProduct"`
	AnnouncementTime   string    `gorm:"column:announcement_time" description:"发布时间" json:"announcementTime"`
	CveId              string    `gorm:"column:cve_id" description:"CVE编号" json:"cveId"`
	Description        string    `gorm:"column:description" description:"描述" json:"description"`
	Introduction       string    `gorm:"column:introduction" description:"简介" json:"introduction"`
	PackageName        string    `gorm:"column:package_name" description:"包名" json:"packageName"`
	ReferenceDocuments string    `gorm:"column:reference_documents" description:"参考文献" json:"referenceDocuments"`
	RevisionHistory    string    `gorm:"column:revision_history" description:"版本历史" json:"revisionHistory"`
	SecurityNoticeNo   string    `gorm:"column:security_notice_no" description:"安全公告编号" json:"securityNoticeNo"`
	Subject            string    `gorm:"column:subject" description:"主题" json:"subject"`
	Summary            string    `gorm:"column:summary" description:"概要" json:"summary"`
	Type               string    `gorm:"column:type" description:"严重级别" json:"type"`
	NoticeType         string    `gorm:"column:notice_type" description:"公告类别" json:"notice_type"`
	Updateime          time.Time `gorm:"column:update_time" description:"更新时间" json:"updateTime"`
}

func (c *CveSecurityNotice) TableName() string {
	return "cve_security_notice"
}

type RCveSecurityNotice struct {
	CveSecurityNotice
	Updateime string `json:"updateTime"`
}

func (c *CveSecurityNotice) IsCveNotice() bool {
	return c.GenNoticeType() == _const.NoticeTypeCVE
}

func (c *CveSecurityNotice) IsHotPatchNotice() bool {
	return strings.Contains(c.SecurityNoticeNo, "HotPatchSA")
}

func (c *CveSecurityNotice) GenNoticeType() string {
	if strings.Contains(c.SecurityNoticeNo, "BA") {
		return _const.NoticeTypeBug
	}

	if strings.Contains(c.SecurityNoticeNo, "HotPatchSA") {
		return _const.NoticeTypeCVE
	}

	if strings.Contains(c.SecurityNoticeNo, "SA") {
		return _const.NoticeTypeCVE
	}

	return ""
}
