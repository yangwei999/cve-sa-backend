package controllers

import (
	"net/http"
	"strings"

	"cve-sa-backend/handles/web"
	"cve-sa-backend/iniconf"
	"cve-sa-backend/utils/entity/cve_sa"
	"cve-sa-backend/utils/tools"

	"github.com/gin-gonic/gin"
	"github.com/gin-gonic/gin/binding"
)

func FindAllSecurity(c *gin.Context) {
	var req cvesa.RequestNotice

	if err := c.ShouldBindWith(&req, binding.JSON); err != nil {
		iniconf.SLog.Error("request err,", err)
		tools.QueryFailure(c)
		return
	}
	datas, err := web.FindAllSecurity(req)
	if err != nil {
		iniconf.SLog.Error("findAllSecurityNotice :", err)
		tools.Failure(c, err.Error())
		return
	}

	tools.Success(c, datas)
}
func GetSecurityNoticePackageByPackageName(c *gin.Context) {
	var req cvesa.RequestData

	if err := c.ShouldBindWith(&req, binding.JSON); err != nil {
		iniconf.SLog.Error("request err,", err)
		tools.QueryFailure(c)
		return
	}
	datas, err := web.GetSecurityNoticePackageByPackageName(req.PackageName)
	if err != nil {
		iniconf.SLog.Error("getSecurityNoticePackageByPackageName :", err)
		tools.Failure(c, err.Error())
		return
	}
	tools.Success(c, datas)
}

func NoticeByCVEID(c *gin.Context) {
	cveId, ok := c.GetQuery("cveId")
	if !ok {
		c.JSON(http.StatusBadRequest, "Required String parameter 'cveId' is not present")
		return
	}
	if cveId == "" {
		tools.Success(c, nil)
		return
	}
	datas, err := web.NoticeByCVEID(cveId)
	if err != nil {
		iniconf.SLog.Error("getCVEDatabaseByCVEID :", err)
		tools.Failure(c, err.Error())
		return
	}
	tools.Success(c, datas)
}

func ByCveIdAndAffectedComponent(c *gin.Context) {
	cveId, ok := c.GetQuery("cveId")
	if !ok {
		c.JSON(http.StatusBadRequest, "Required String parameter 'cveId' is not present")
		return
	}
	if cveId == "" {
		tools.Success(c, nil)
		return
	}
	affectedComponent, ok := c.GetQuery("affectedComponent")
	if !ok {
		c.JSON(http.StatusBadRequest, "Required String parameter 'affectedComponent' is not present")
		return
	}
	datas, err := web.ByCveIdAndAffectedComponent(cveId, affectedComponent)
	if err != nil {
		iniconf.SLog.Error("byCveIdAndAffectedComponent :", err)
		tools.Failure(c, err.Error())
		return
	}
	tools.Success(c, datas)
}

func NoticeBySecurityNoticeNo(c *gin.Context) {
	securityNoticeNo, ok := c.GetQuery("securityNoticeNo")
	if !ok {
		c.JSON(http.StatusBadRequest, "Required String parameter 'securityNoticeNo' is not present")
		return
	}
	if securityNoticeNo == "" {
		tools.Success(c, nil)
		return
	}
	data, err := web.NoticeBySecurityNoticeNo(securityNoticeNo)
	if err != nil {
		iniconf.SLog.Error("getSecurityNoticeBySecurityNoticeNo :", err)
		tools.Failure(c, err.Error())
		return
	}
	tools.Success(c, data)
}

func GetAffectedProduct(c *gin.Context) {
	data := web.FindAllAffectedProduct()

	tools.Success(c, data)
}

func MaxNoticeId(c *gin.Context) {
	noticeType, ok := c.GetQuery("notice_type")
	if !ok {
		c.JSON(http.StatusBadRequest, "Required String parameter 'notice_type' is not present")

		return
	}

	if noticeType == "" {
		tools.Success(c, nil)

		return
	}

	data, err := web.MaxNoticeId(noticeType)
	if err != nil {
		iniconf.SLog.Error("MaxNoticeId :", err)
		tools.Failure(c, err.Error())

		return

	}

	tools.Success(c, data)
}

func GetAffectedComponent(c *gin.Context) {
	securityLevel := c.DefaultQuery("securityLevel", "")
	affectedProduct := c.DefaultQuery("affectedProduct", "")
	noticeType := c.DefaultQuery("noticeType", "")

	var level, product []string
	if securityLevel != "" {
		level = strings.Split(securityLevel, ",")
	}

	if affectedProduct != "" {
		product = strings.Split(affectedProduct, ",")
	}

	data := web.FindAllAffectedComponent(level, product, noticeType)

	tools.Success(c, data)
}

func PublishedBugs(c *gin.Context) {
	data, err := web.PublishedBugs()
	if err != nil {
		iniconf.SLog.Error("PublishedBugs :", err)
		tools.Failure(c, err.Error())

		return
	}

	tools.Success(c, data)
}
